{% extends "base_bs.html" %}
{% load comments %}

{% block container %}
<div class="row">
  <div class="span6 offset3">
    <h1>
      {{ object.name }}
    {% if user.is_authenticated %}
    <span class="pull-right" id="outer_bookmark">
    {% if object in user.get_profile.fav_recipes.all %}
      <i class="icon-bookmark" id="bookmark"></i>
    {% else %}
      <i class="icon-bookmark-empty" id="bookmark"></i>
    {% endif %}
    </span>
    {% endif %}
    </h1>
    <h5>From <em>{{object.origin}}</em></h5>
  </div>
</div>

<div class="row">
  
  <div class="span8 offset2">
    <div class="row">
      <div class="span3">
	<h3>Ingredients:</h3>
	<ul style="padding:0px;margin:0px;list-style-position:inside;">
	  {% for ingredient in object.recipeingredient_set.all %}
	  <li> {{ ingredient }} </li>
	  {% endfor %}
	</ul>
      </div>
      <div class="span5">
	<h3>Directions:</h3>
	<ol style="padding:0px;margin:0px">
	  {% for instruction in object.instructionstep_set.all %}
	  <li> {{ instruction }}</li>
	  {% endfor %}
	</ol>
      </div>
    </div>

    <div class="row">
      <hr />
      <div class="span3">
	<div class="well">
	  <h4>Nutrition Information</h4>
	  <ul>
	    {% with nut_info=object.nutrition %}
	    <li>Servings: {{object.servings}}</li>
	    <li>Serving Size: {{ nut_info.weight }}g</li>
	    <li>Calories: {{ nut_info.calories }}</li>
	    <li>Carbohydrate: {{ nut_info.carbohydrate }}g</li>
	    <li>Protein: {{ nut_info.protein }}g</li>
	    <li>Fat: {{ nut_info.fat }}g</li>
	    {#<li>Errors: {{ nut_info.errors|linebreaks }}</li>#}
	    {% endwith %}
	  </ul>
	</div>
      </div>
    {% if object.foodpicture_set.all %}
    <div class="span5">
      <ul class="thumbnails">
	{% for picture in object.foodpicture_set.all %}
	{% if forloop.first %}
	<li class="span3">
        {% else %}
	<li class="span2">
	  {% endif %}
	  <a href="{{picture.link_address}}" class="thumbnail">
	    <img src="{{picture.img_address}}" 
		 alt="{{object.name}}-{{forloop.counter}}" />
          </a>
	</li>
	{% endfor %}
      </ul>
    </div>
    {% endif %}
    </div>
    <div class="row">
      <hr />
      <div class="span5">
      <h4>Comments:</h4>
      {% get_comment_list for object as comment_list %}
      {% for comment in comment_list %}
      {% with comment.user as commenter %}
      <div class="well">
	<p>
	  {{ comment.comment }}
	</p>
	<p class="pull-right">
	  {% if commenter.first_name %}
          {{commenter.first_name}} {{commenter.last_name}}, 
	  {% else %}
          {{commenter.username}}, 
	  {% endif %}
	  <em>{{comment.submit_date|date:"M j, Y"}}</em>
	</p>
      </div>
      {% endwith %}
      {% empty %}
      <p>
	No comments yet.  Be the first to add one!
      </p>
      {% endfor %}
      </div>
      {% if user.is_authenticated %}
      <div class="span3">
      {% get_comment_form for object as form %}
      <form action="{% comment_form_target %}" method="post">
	<legend>Add a Comment</legend>
	{% csrf_token %}
	{% for field in form %}
	{% if field.is_hidden %}
	<div>{{ field }}</div>
	{% elif field.name in "nameemailurl" %}
	<div style="display:none">
	  {{ field }}
	</div>
	{% else %}
	{% if field.errors %}{{ field.errors }}{% endif %}
	<p
           {% if field.errors %} class="error"{% endif %}
           {% ifequal field.name "honeypot" %} style="display:none;"{% endifequal %}>
          {{ field.label_tag }} {{ field }}
	</p>
	{% endif %}
	{% endfor %}


	<input type="hidden" name="next" value="{{ request.get_full_path }}" />        
	<button class="btn btn-primary" type="submit" name="submit" value="Post">Post</button>
        <button class="btn" type="submit" name="preview" value="Preview">Preview</button>
      </form>
      </div>
      {% else %}
      Only registered users may comment. <a href="/accounts/login/" class="btn btn-primary" style="margin-top:1em;">Login</a> or <a href="/accounts/register/" class="btn btn-success" style="margin-top:1em;">Register</a>
      {% endif %}
    </div>
  </div>
  
</div>
{% endblock container %}

{% block custom_script %}
<script>
$(document).ready(function() {
  $.ajaxSetup({
    crossDomain: false,
    beforeSend: function(xhr, settings) {
        if (/^(POST|PUT|DELETE)$/.test(settings.type)) {
            xhr.setRequestHeader("X-CSRFToken", "{{csrf_token}}");
        }
    }
  });
  $("#outer_bookmark").on("click",function(event) {
    var method_type = "PUT";
    var cur_icn = $(this).children("i").first();
    if (cur_icn.hasClass("icon-bookmark")) {
      method_type = "DELETE";
    };
    $.ajax({
      type: method_type,
      data: { key: "val" },
      url: "/recipes/fav/{{object.slug}}/"
    }).done(function() {
      cur_icn.toggleClass("icon-bookmark icon-bookmark-empty");
    });

  });
});
</script>
{% endblock custom_script %}
